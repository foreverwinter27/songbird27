<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>songbird</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Patrick+Hand&family=Nunito:wght@400;600&family=Sacramento&family=Poppins:wght@300;500&family=Lora&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg1: #f7c6d9; --bg2: #e6d9ff; --card: rgba(255, 250, 243, 0.95);
            --accent: #d9f5e8; --text: #4a3f4b; --font: "quicksand"; --size: 16px;
            --melody-glow: #ffb7ce;
        }
        body { 
            margin: 0; font-family: var(--font), sans-serif; font-size: var(--size); 
            background: linear-gradient(120deg, var(--bg1), var(--bg2)); 
            background-attachment: fixed; color: var(--text); min-height: 100vh; 
            text-transform: lowercase; transition: 0.5s; overflow-x: hidden;
        }
        
        #authScreen { position: fixed; inset: 0; background: linear-gradient(var(--bg1), var(--bg2)); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--card); padding: 40px; border-radius: 40px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.1); width: 320px; border: 2px solid white; }

        header { text-align: center; padding: 25px; font-family: "patrick hand", cursive; font-size: 2.3em; position: relative; }
        #settingsBtn, #chatBtn { position: absolute; top: 25px; cursor: pointer; font-size: 0.8em; z-index: 100; }
        #settingsBtn { right: 25px; } #chatBtn { left: 25px; }
        
        .header-bird { display: inline-block; animation: chirp 3s infinite; font-size: 0.8em; margin-left: 5px; }
        @keyframes chirp { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-5px) rotate(5deg); } }

        nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; padding: 0 10px; }
        nav button { background: var(--card); border: none; border-radius: 20px; padding: 8px 15px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: 0.3s; }
        
        section { display: none; padding: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        section.active { display: block; animation: fadeIn 0.5s; }

        .card { background: var(--card); border-radius: 30px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5); position: relative; }
        input, textarea, select { width: 100%; border: 1px solid #eee; border-radius: 15px; padding: 12px; margin-bottom: 10px; font-family: inherit; box-sizing: border-box; background: white; }
        .btn { background: var(--accent); border: none; border-radius: 20px; padding: 12px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 5px; transition: 0.2s; color: var(--text); }

        .calendar-grid { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin: 15px 0; }
        .cal-day { width: 14px; height: 14px; background: rgba(0,0,0,0.05); border-radius: 3px; transition: 0.3s; }
        .cal-day.active { background: #fff; box-shadow: 0 0 8px var(--melody-glow), 0 0 2px var(--melody-glow); border: 1px solid #ffdeeb; }

        .mood-opt { font-size: 1.8em; cursor: pointer; padding: 10px; opacity: 0.3; filter: grayscale(1); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }
        .mood-opt.selected { opacity: 1; filter: grayscale(0); transform: scale(1.4); filter: drop-shadow(0 0 8px var(--melody-glow)); }

        .musical-card { background: white; border-radius: 25px; padding: 25px; border: 1px solid #eee; box-shadow: 0 15px 40px rgba(0,0,0,0.04); text-align: center; }
        .musical-card h2 { font-family: 'quicksand'; color: #5a4a5c; margin: 0; font-size: 1.8em; font-weight: 600; }
        .fav-list { text-align: left; background: #fcfaff; padding: 15px; border-radius: 20px; margin-top: 15px; }
        .fav-list div { padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }

        .wrapped-header { background: #ffecf2; padding: 20px; border-radius: 25px 25px 0 0; margin: -25px -25px 15px -25px; text-align: center; }
        .wrapped-header h2 { font-family: 'sacramento'; font-size: 2.5em; margin: 0; color: #ff85a2; }
        .wrapped-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .wrapped-item { background: white; padding: 12px; border-radius: 20px; text-align: center; border: 1px solid #ffdeeb; }

        #aiChat { display: none; position: fixed; bottom: 80px; left: 20px; width: 300px; height: 420px; background: white; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 9000; flex-direction: column; border: 3px solid var(--bg1); overflow: hidden; }
        #chatHeader { background: var(--bg1); padding: 15px; cursor: grab; font-weight: 600; display: flex; justify-content: space-between; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 15px; border-radius: 20px; max-width: 80%; font-size: 0.9em; }
        .bot { background: #f5f5f5; align-self: flex-start; border-bottom-left-radius: 5px; }
        .user { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 5px; }

        .option-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #eee; border-radius: 15px; cursor: pointer; background: white; font-family: inherit; }
        .correct { background: #d4edda !important; }
        .wrong { background: #f8d7da !important; }

        .settings-group { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #f0f0f0; }
        .settings-group label { display: block; font-size: 0.75em; font-weight: bold; margin-bottom: 8px; opacity: 0.6; }

        #modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:11000; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="authScreen">
    <div class="auth-box">
        <h1 style="font-family: 'sacramento'; font-size: 3.5em; margin: 0;">songbird</h1>
        <p style="margin-bottom: 25px; opacity: 0.7;">your musical sanctuary</p>
        <input id="authUser" placeholder="username">
        <input id="authPin" type="password" placeholder="pin">
        <button class="btn" onclick="handleAuth('login')">log in</button>
        <button class="btn" style="background: white; border: 1px solid #eee; margin-top: 10px;" onclick="handleAuth('signup')">sign up</button>
    </div>
</div>

<div id="aiChat">
    <div id="chatHeader" onmousedown="startDrag(event)"><span>melody ‚ô°</span><span onclick="toggleChat()" style="cursor:pointer;">‚úï</span></div>
    <div id="chatMessages"></div>
    <div style="padding: 10px; display: flex; gap: 5px; border-top: 1px solid #eee;">
        <input id="chatInput" placeholder="talk to me..." onkeypress="if(event.key==='Enter') sendChat()">
        <button onclick="sendChat()" style="border:none; background:none; cursor:pointer; font-size: 1.2em;">‚ú®</button>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()">
    <div class="card" style="width: 80%; max-width: 400px; text-align: center; background: white;" onclick="event.stopPropagation()">
        <h3 id="modalTitle"></h3><p id="modalText"></p><button class="btn" onclick="closeModal()">got it!</button>
    </div>
</div>

<header>
    <span id="chatBtn" onclick="toggleChat()">üí¨</span>
    songbird <span class="header-bird">üê¶</span>
    <span id="settingsBtn" onclick="toggleSettings()">‚öôÔ∏è</span>
</header>

<nav>
    <button onclick="show('home')">diary</button>
    <button onclick="show('questions')">questions</button>
    <button onclick="show('timeline')">timeline</button>
    <button onclick="show('arcade')">arcade</button>
    <button onclick="show('profile')">profile</button>
</nav>

<section id="home" class="active">
    <div class="card" style="text-align: center;"><h4 style="margin:0; opacity:0.6;">lyric of the day</h4><p id="dailyLyric" style="font-family: 'sacramento'; font-size: 1.8em; margin: 15px 0;"></p></div>
    <div class="card">
        <h3>new entry</h3>
        <input id="songInput" placeholder="what's playing?">
        <div style="text-align: center; margin: 15px 0;">
            <span onclick="setMood('üå∏', this)" class="mood-opt">üå∏</span>
            <span onclick="setMood('‚ú®', this)" class="mood-opt">‚ú®</span>
            <span onclick="setMood('üò≠', this)" class="mood-opt">üò≠</span>
            <span onclick="setMood('üò°', this)" class="mood-opt">üò°</span>
            <span onclick="setMood('üò¥', this)" class="mood-opt">üò¥</span>
            <span onclick="setMood('üòç', this)" class="mood-opt">üòç</span>
            <span onclick="setMood('üòã', this)" class="mood-opt">üòã</span>
        </div>
        <textarea id="notesInput" rows="3" placeholder="dear diary..."></textarea>
        <button class="btn" onclick="saveEntry('diary')">save entry</button>
    </div>
</section>

<section id="questions">
    <div class="card">
        <h3 id="questionPrompt">loading...</h3>
        <input id="qSong" placeholder="song title">
        <textarea id="qWhy" placeholder="why this song?"></textarea>
        <button class="btn" onclick="saveEntry('question')">save answer</button>
        <button class="btn" onclick="nextQuestion()" style="background:#f0f0f0; margin-top:10px;">new prompt</button>
    </div>
</section>

<section id="timeline">
    <div class="card" style="text-align: center;">
        <div class="calendar-grid" id="calGrid"></div>
        <h3 id="entryCounter">0 memories</h3>
        <input id="searchTimeline" placeholder="search memories..." oninput="loadTimeline(this.value)">
        <div id="timelineList"></div>
    </div>
</section>

<section id="arcade">
    <div class="card" style="text-align: center;"><h3>score: <span id="gameScore">0</span></h3></div>
    <div class="card">
        <h4>guess the artist</h4>
        <button class="btn" style="background:#fff; border:1px solid #eee; font-size:0.75em; margin-bottom:10px;" onclick="openModal('how to play', 'identify the correct artist for the song! +5 points')">how to play?</button>
        <div id="artistDisplay"><button class="btn" onclick="startArtistGame()">start game</button></div>
    </div>
    <div class="card">
        <h4>guess the song</h4>
        <button class="btn" style="background:#fff; border:1px solid #eee; font-size:0.75em; margin-bottom:10px;" onclick="openModal('how to play', 'a lyric will appear‚Äîcan you name the song? +5 points')">how to play?</button>
        <div id="songDisplay"><button class="btn" onclick="startSongGame()">start game</button></div>
    </div>
    <div class="card">
        <h4>finish the lyric</h4>
        <button class="btn" style="background:#fff; border:1px solid #eee; font-size:0.75em; margin-bottom:10px;" onclick="openModal('how to play', 'type the missing word from the lyric. +10 points!')">how to play?</button>
        <div id="finishDisplay"><button class="btn" onclick="startFinishGame()">start game</button></div>
    </div>
</section>

<section id="profile">
    <div class="card" style="text-align: center;">
        <h2 id="dispStreak">üî• 0 days</h2>
        <input id="pName" placeholder="your name">
        <input id="pPronouns" placeholder="pronouns">
        <textarea id="pBio" placeholder="bio..."></textarea>
        <input id="pFavSong" placeholder="fav song">
        <input id="pFavArtist" placeholder="fav singer">
        <input id="pFavLyric" placeholder="fav lyric">
        <button class="btn" onclick="saveProfile()">update profile</button>
    </div>
    <div class="card"><h3>friends list üéÄ</h3><div id="friendsList"></div></div>
    <div class="card">
        <h3>find users</h3>
        <input id="searchUserInput" placeholder="username...">
        <button class="btn" onclick="findUser()">search</button>
        <div id="userSearchResult" style="margin-top:15px;"></div>
    </div>
    <div class="card" id="wrappedSection">
        <h3>wrapped üéÅ</h3>
        <button class="btn" onclick="generateWrapped()">open monthly wrapped</button>
        <div id="wrappedContent"></div>
    </div>
</section>

<div id="settingsPanel" style="display:none; position:fixed; top:75px; right:20px; width:280px; max-height:80vh; overflow-y:auto; background:var(--card); padding:25px; border-radius:30px; z-index:9500; border:2px solid white; box-shadow:0 10px 40px rgba(0,0,0,0.15);">
    <h3 style="margin-top:0">settings</h3>
    <div class="settings-group">
        <label>appearance</label>
        <select onchange="updateTheme(this.value)"><option value="pink">pink</option><option value="lavender">lavender</option><option value="mint">mint</option><option value="blue">blue</option><option value="midnight">midnight üåô</option></select>
        <select onchange="document.body.style.fontFamily = this.value"><option value="quicksand">quicksand</option><option value="poppins">poppins</option><option value="lora">lora</option></select>
        <select onchange="document.body.style.fontSize = this.value"><option value="14px">small</option><option value="16px" selected>medium</option><option value="18px">large</option></select>
    </div>
    <div class="settings-group">
        <label>notifications</label>
        <div style="display:flex; gap:5px;"><input id="notifTime" type="number" min="1" max="12" value="8" style="margin:0"><select id="notifPeriod" style="margin:0"><option value="AM">AM</option><option value="PM" selected>PM</option></select></div>
    </div>
    <button class="btn" onclick="confirmAction('logout')" style="background:#f5f5f5; margin-top:10px;">log out</button>
    <button class="btn" onclick="confirmAction('delete')" style="background:#ffebee; color:#d32f2f; margin-top:5px;">delete account</button>
</div>

<script>
let currentUser = "";
let score = 0;
let selectedMood = "";
const songs = [
    { s: "espresso", a: "sabrina carpenter", l: "i'm working late 'cause i'm a singer", m: "singer" },
    { s: "cruel summer", a: "taylor swift", l: "fever dream high in the quiet of the night", m: "quiet" },
    { s: "vampire", a: "olivia rodrigo", l: "bleeding me dry like a goddamn vampire", m: "vampire" },
    { s: "love language", a: "ariana grande", l: "i'm just gon make you my home", m: "home" },
{ s: "forever winter", a: "taylor swift", l: "i'll be summer sun for you forever", m: "summer" },
{ s: "sharpest tool", a: "sabrina carpenter", l: "we were going right then you took a left", m: "took" },
{ s: "hot to go", a: "chappell roan", l: "you can take me hot to go", m: "hot" },
{ s: "bittersuite", a: "billie eilish", l: "i've been overseas and i've been havin dreams", m: "havin" },
{ s: "when did you get hot", a: "sabrina carpenter", l: "it's thickening the plot", m: "plot" },
{ s: "red", a: "taylor swift", l: "loving him was red", m: "red" },
{ s: "wildest dreams", a: "taylor swift", l: "say you'll remember me", m: "me" },
{ s: "the subway", a: "chappell roan", l: "i saw your green hair, beauty mark next to your mouth", m: "green" },
{ s: "gnarly", a: "katseye", l: "everything's gnarly", m: "gnarly" },
{ s: "sports car", a: "tate mcrae", l: "hey cute jeans", m: "jeans" },
{ s: "best guess", a: "lucy dacus", l: "if i were a gambling man and i am you'd be my best bet", m: "bet" },
{ s: "caramel", a: "conan gray", l: "you burn inside my memory so well", m: "burn" },
{ s: "7 rings", a: "ariana grande", l: "i see it i like it i want it i got it", m: "want" },
    { s: "we can't be friends", a: "ariana grande", l: "wait for your love my love", m: "wait" },
    { s: "please please please", a: "sabrina carpenter", l: "heartbreak is one thing my ego's another", m: "ego" },
    { s: "feather", a: "sabrina carpenter", l: "i feel so much lighter like a feather", m: "lighter" },
    { s: "lunch", a: "billie eilish", l: "i could eat that girl for lunch", m: "lunch" },
    { s: "good 4 u", a: "olivia rodrigo", l: "well good for you you look happy and healthy", m: "healthy" },
    { s: "thank u next", a: "ariana grande", l: "one taught me love one taught me patience", m: "patience" },
    { s: "nonsense", a: "sabrina carpenter", l: "i'm talkin' nonsense", m: "nonsense" },
    { s: "bed chem", a: "sabrina carpenter", l: "where art thou? why not uponeth me?", m: "thou" },
    { s: "it's ok i'm ok", a: "tate mcrae", l: "you can have him anyway", m: "anyway" },
    { s: "ocean eyes", a: "billie eilish", l: "no fair you really know how to make me cry", m: "ocean" },
    { s: "happier than ever", a: "billie eilish", l: "when i'm away from you i'm happier than ever", m: "happier" },
    { s: "obsessed", a: "olivia rodrigo", l: "i'm so obsessed with your ex", m: "obsessed" },
    { s: "i love you i'm sorry", a: "gracie abrams", l: "you were the best but you were the worst", m: "worst" },
    { s: "heather", a: "conan gray", l: "why would you ever kiss me?", m: "kiss" },
    { s: "close to you", a: "gracie abrams", l: "just let me be close to you", m: "close" },
    { s: "memories", a: "conan gray", l: "please don't ruin this for me", m: "ruin" },
    { s: "good luck babe", a: "chappell roan", l: "you can kiss a hundred boys in bars", m: "bars" },
    { s: "wildflower", a: "billie eilish", l: "did i cross the line?", m: "line" },
{ s: "the boy is mine", a: "ariana grande", l: "i can't wait to try him", m: "wait" },
        { s: "juno", a: "sabrina carpenter", l: "i might let you make me juno", m: "juno" },
    { s: "what was i made for?", a: "billie eilish", l: "i used to float now i just fall down", m: "float" },
    { s: "chihiro", a: "billie eilish", l: "open up the door can you open up the door?", m: "door" },
    { s: "vicious", a: "sabrina carpenter", l: "you're so vicious", m: "vicious" },
        { s: "34+35", a: "ariana grande", l: "can you stay up all night?", m: "night" },
    { s: "everything i wanted", a: "billie eilish", l: "as long as i'm here no one can hurt you", m: "hurt" },
    { s: "dangerous woman", a: "ariana grande", l: "somethin' 'bout you makes me feel like a dangerous woman", m: "dangerous" },
    { s: "taste", a: "sabrina carpenter", l: "i heard you're back together and if that's true", m: "true" },
{ s: "hampstead", a: "ariana grande", l: "i would rather feel everything than nothing every time", m: "rather" },
{ s: "red wine supernova", a: "chappell roan", l: "i heard you like magic, i've got a wand and a rabbit", m: "wand" },
{ s: "the bottom", a: "gracie abrams", l: "cause i'm no good you could do better", m: "good" },
    { s: "favorite crime", a: "olivia rodrigo", l: "know that i loved you so bad i let you treat me like that", m: "treat" },
    { s: "eternal sunshine", a: "ariana grande", l: "i'll be the first to say i'm sorry", m: "sorry" },
    { s: "cardigan", a: "taylor swift", l: "when you are young they assume you know nothing", m: "nothing" },
    { s: "willow", a: "taylor swift", l: "life was a willow and it bent right to your wind", m: "willow" },
    { s: "reckless", a: "madison beer", l: "each day goes by and each night i cry", m: "cry" },
    { s: "anti-hero", a: "taylor swift", l: "it's me hi i'm the problem it's me", m: "problem" },


];

function startDrag(e) {
    const chat = document.getElementById("aiChat");
    let shiftX = e.clientX - chat.getBoundingClientRect().left;
    let shiftY = e.clientY - chat.getBoundingClientRect().top;
    function moveAt(pageX, pageY) { chat.style.left = pageX - shiftX + 'px'; chat.style.top = pageY - shiftY + 'px'; chat.style.bottom = 'auto'; }
    function onMouseMove(e) { moveAt(e.clientX, e.clientY); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function() { document.removeEventListener('mousemove', onMouseMove); document.onmouseup = null; };
}

function handleAuth(type) {
    const user = document.getElementById("authUser").value.trim().toLowerCase();
    const pin = document.getElementById("authPin").value;
    if(!user || !pin) return;
    let db = JSON.parse(localStorage.getItem("melody_db") || "{}");
    if(type==='signup') {
        if(db[user]) return alert("user exists!");
        db[user] = { pin, entries: [], profile: {}, score: 0, friends: [] };
    } else if(!db[user] || db[user].pin !== pin) return alert("wrong info!");
    currentUser = user; saveDB(db);
    document.getElementById("authScreen").style.display = "none";
    loadData();
}

function loadData() {
    const db = getDB(); const u = db[currentUser];
    score = u.score || 0; const p = u.profile || {};
    document.getElementById("pName").value = p.name || "";
    document.getElementById("pPronouns").value = p.pronouns || "";
    document.getElementById("pBio").value = p.bio || "";
    document.getElementById("pFavSong").value = p.song || "";
    document.getElementById("pFavArtist").value = p.artist || "";
    document.getElementById("pFavLyric").value = p.lyric || "";
    document.getElementById("gameScore").textContent = score;
    document.getElementById("dailyLyric").textContent = songs[Math.floor(Math.random()*songs.length)].l;
    updateStreak(); loadFriends(); nextQuestion(); initMelody();
}

function initMelody() {
    const p = getDB()[currentUser].profile;
    const greet = p.artist ? `hi ${p.artist} fan! ready to write?` : "hi! how are you feeling?";
    document.getElementById("chatMessages").innerHTML = `<div class="msg bot">${greet}</div>`;
}

function sendChat() {
    const input = document.getElementById("chatInput");
    if(!input.value) return;
    
    // Show user message
    document.getElementById("chatMessages").innerHTML += `<div class="msg user">${input.value}</div>`;
    
    const inputLower = input.value.toLowerCase();
    let botResponse = "";

    // 1. CHIT-CHAT LOGIC (Greetings/Politeness)
    if (inputLower.includes("thank")) {
        botResponse = "you're so welcome! i'm always here to listen. ‚ô°";
    } else if (inputLower.includes("hello") || inputLower.includes("hi ") || inputLower.eq === "hi") {
        botResponse = "hi fellow birdie! what's on your mind (and your playlist) today?";
    } else if (inputLower.includes("bye") || inputLower.includes("goodnight")) {
        botResponse = "bye for now! see you soon :)";
    } else if (inputLower.includes("who are you")) {
        botResponse = "i'm melody, your personal songbird! i live to talk about music and feelings.";
    }

    // 2. EMOTION LOGIC (Only runs if we don't have a chit-chat response yet)
    if (!botResponse) {
        const moodMap = {
            happy: { s: "espresso", a: "sabrina carpenter" },
            sad: { s: "i love you i'm sorry", a: "gracie abrams" },
            depressed: { s: "what was i made for?", a: "billie eilish" },
            angry: { s: "vampire", a: "olivia rodrigo" },
            annoyed: { s: "please please please", a: "sabrina carpenter" },
            disappointed: { s: "astronomy", a: "conan gray" },
            excited: { s: "7 rings", a: "ariana grande" }
        };

        for (let mood in moodMap) {
            if (inputLower.includes(mood)) {
                botResponse = `i feel you. since you're feeling ${mood}, you should listen to "${moodMap[mood].s}" by ${moodMap[mood].a}. ‚ô°`;
                break;
            }
        }
    }

    // 3. FALLBACK (If no keywords match)
    if (!botResponse) {
        botResponse = "that's interesting! tell me more about that?";
    }

    // Show bot response after a tiny delay
    setTimeout(() => { 
        document.getElementById("chatMessages").innerHTML += `<div class="msg bot">${botResponse}</div>`; 
        const chatBox = document.getElementById("chatMessages");
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 600);

    input.value = "";
}

function saveEntry(type) {
    let db = getDB();
    let song = type === 'diary' ? document.getElementById("songInput").value : document.getElementById("qSong").value;
    let note = type === 'diary' ? document.getElementById("notesInput").value : document.getElementById("qWhy").value;
    if(!song) return;
    const e = { id: Date.now(), song, notes: note, mood: selectedMood || "‚ú®", date: new Date().toLocaleDateString() };
    db[currentUser].entries.unshift(e); saveDB(db); updateStreak();
    if(type==='diary') { 
        document.getElementById("songInput").value = ""; 
        document.getElementById("notesInput").value = ""; 
        selectedMood = "";
        document.querySelectorAll(".mood-opt").forEach(o => { 
            o.classList.remove('selected');
        });
    }
    else { document.getElementById("qSong").value = ""; document.getElementById("qWhy").value = ""; nextQuestion(); }
}

function deleteEntry(id) {
    if(confirm("delete this memory?")) {
        let db = getDB();
        db[currentUser].entries = db[currentUser].entries.filter(e => e.id !== id);
        saveDB(db); loadTimeline(); updateStreak();
    }
}

function findUser() {
    const u = document.getElementById("searchUserInput").value.toLowerCase();
    const db = getDB(); const res = document.getElementById("userSearchResult");
    if(db[u]) {
        const p = db[u].profile || {};
        res.innerHTML = `
            <div class="musical-card">
                <h2>${u}</h2>
                <span style="opacity:0.6; font-size:0.8em;">${p.pronouns || ''}</span>
                <p style="margin: 10px 0;">${p.bio || 'no bio yet...'}</p>
                <div class="fav-list">
                    <div><b>singer:</b> ${p.artist || '...'}</div>
                    <div><b>song:</b> ${p.song || '...'}</div>
                    <div><b>lyric:</b> "${p.lyric || '...'}"</div>
                </div>
                <button class="btn" style="background:white; border:1px solid #eee; margin-top:10px;" onclick="addFriend('${u}')">add friend +</button>
            </div>`;
    } else res.innerHTML = "user not found";
}

function addFriend(n) { 
    let db = getDB(); 
    if(!db[currentUser].friends) db[currentUser].friends = [];
    if(!db[currentUser].friends.includes(n)) { db[currentUser].friends.push(n); saveDB(db); loadFriends(); alert("added!"); }
}

function loadFriends() {
    const list = document.getElementById("friendsList"); const f = getDB()[currentUser].friends || [];
    list.innerHTML = f.length ? "" : "<p style='opacity:0.5; font-size:0.8em;'>no friends yet</p>";
    f.forEach(name => { list.innerHTML += `<div style="background:white; padding:10px; border-radius:15px; margin-bottom:5px; border:1px solid #f0f0f0;">‚ú® ${name}</div>`; });
}

function startArtistGame() {
    const div = document.getElementById("artistDisplay");
    const correct = songs[Math.floor(Math.random() * songs.length)];
    
    // Master list of artists for variety
    const allArtists = [
        "ariana grande", "billie eilish", "tate mcrae", 
        "gracie abrams", "conan gray", "olivia rodrigo", 
        "taylor swift", "sabrina carpenter", "chappell roan",
        "lana del rey", "dua lipa", "miley cyrus"
    ];

    // Duplicate Protection: Remove the correct artist from the wrong choices pool
    const wrongChoicesPool = allArtists.filter(name => name.toLowerCase() !== correct.a.toLowerCase());
    
    // Pick 2 random unique wrong names
    const randomWrongChoices = wrongChoicesPool.sort(() => Math.random() - 0.5).slice(0, 2);

    // Combine and shuffle
    const choices = [correct.a, ...randomWrongChoices].sort(() => Math.random() - 0.5);

    div.innerHTML = `<p>who sings "${correct.s}"?</p>`;
    choices.forEach(c => {
        const b = document.createElement("button");
        b.className = "option-btn";
        b.textContent = c;
        b.onclick = () => {
            if (c.toLowerCase() === correct.a.toLowerCase()) {
                b.classList.add("correct");
                score += 5;
                updateS();
                setTimeout(startArtistGame, 600);
            } else {
                b.classList.add("wrong");
            }
        };
        div.appendChild(b);
    });
}

function startSongGame() {
    const div = document.getElementById("songDisplay");
    const correct = songs[Math.floor(Math.random() * songs.length)];
    
    // Duplicate Protection: Filter out the correct song title from your entire 60-song library
    const wrongSongsPool = songs.filter(item => item.s.toLowerCase() !== correct.s.toLowerCase());
    
    // Pick 2 random unique wrong song titles
    const randomWrongSongs = wrongSongsPool.sort(() => Math.random() - 0.5).slice(0, 2).map(item => item.s);

    // Combine correct title and the 2 wrong titles
    const choices = [correct.s, ...randomWrongSongs].sort(() => Math.random() - 0.5);

    div.innerHTML = `<p>"${correct.l}"</p>`;
    choices.forEach(c => {
        const b = document.createElement("button");
        b.className = "option-btn";
        b.textContent = c;
        b.onclick = () => {
            if (c.toLowerCase() === correct.s.toLowerCase()) {
                b.classList.add("correct");
                score += 5;
                updateS();
                setTimeout(startSongGame, 600);
            } else {
                b.classList.add("wrong");
            }
        };
        div.appendChild(b);
    });
}



function startFinishGame() {
    const div = document.getElementById("finishDisplay"); const item = songs[Math.floor(Math.random()*songs.length)];
    div.innerHTML = `<p>${item.l.replace(item.m, "______")}</p><input id="finIn" placeholder="missing word..."><button class="btn" onclick="checkFinish('${item.m}')">submit</button>`;
}
function checkFinish(a) { if(document.getElementById("finIn").value.toLowerCase().trim() === a) { score += 10; updateS(); startFinishGame(); } else alert("try again!"); }

function generateWrapped() {
    const u = getDB()[currentUser]; const now = new Date(); const currentMonth = now.toLocaleString('default', { month: 'long' });
    const monthlyEntries = u.entries.filter(e => new Date(e.date).getMonth() === now.getMonth());
    if(monthlyEntries.length < 1) return alert("log more first!");
    const moods = {}; monthlyEntries.forEach(x => moods[x.mood] = (moods[x.mood]||0)+1);
    const topMood = Object.keys(moods).reduce((a,b) => moods[a] > moods[b] ? a : b);
    document.getElementById("wrappedContent").innerHTML = `
        <div id="captureArea" class="card" style="padding: 25px; border: 2px solid #ffdeeb; background: white; position: relative;">
            <span onclick="document.getElementById('wrappedContent').innerHTML=''" style="position:absolute; top:15px; right:15px; cursor:pointer; color:#ff85a2;">‚úï</span>
            <div class="wrapped-header"><h2>${currentMonth}</h2><p>SONGBIRD WRAPPED 2026</p></div>
            <div class="wrapped-grid">
                <div class="wrapped-item"><small>memories</small><br><b>${monthlyEntries.length}</b></div>
                <div class="wrapped-item"><small>top vibe</small><br><b>${topMood}</b></div>
                <div class="wrapped-item"><small>arcade score</small><br><b>${score}</b></div>
                <div class="wrapped-item"><small>idol</small><br><b>${u.profile.artist || 'eclectic'}</b></div>
            </div>
        </div>
        <button class="btn" onclick="shareWrapped()">üì∏ save wrapped</button>`;
}

function shareWrapped() {
    html2canvas(document.getElementById("captureArea")).then(canvas => { const link = document.createElement('a'); link.download = `wrapped.png`; link.href = canvas.toDataURL(); link.click(); });
}

function updateTheme(v) {
    const t = { 
        pink: ['#f7c6d9','#e6d9ff','#4a3f4b'], 
        lavender: ['#e0c3fc','#8ec5fc','#4a3f4b'], 
        mint: ['#b9fbc0','#cfbac0','#2d4a3e'], 
        blue: ['#a2d2ff','#ffffff','#1b4965'], 
        midnight: ['#1a1a2e','#16213e','#e94560'] 
    };
    document.documentElement.style.setProperty('--bg1', t[v][0]); document.documentElement.style.setProperty('--bg2', t[v][1]);
    if(v === 'midnight') {
        document.documentElement.style.setProperty('--card', 'rgba(26, 26, 46, 0.95)');
        document.body.style.color = "white";
    } else {
        document.documentElement.style.setProperty('--card', 'rgba(255, 250, 243, 0.95)');
        document.body.style.color = t[v][2];
    }
}

function getDB() { return JSON.parse(localStorage.getItem("melody_db") || "{}"); }
function saveDB(db) { localStorage.setItem("melody_db", JSON.stringify(db)); }
function show(id) { document.querySelectorAll("section").forEach(s => s.classList.remove("active")); document.getElementById(id).classList.add("active"); if(id==='timeline') loadTimeline(); }
function toggleChat() { const c = document.getElementById("aiChat"); c.style.display = (c.style.display==='flex')?'none':'flex'; }
function toggleSettings() { const s = document.getElementById("settingsPanel"); s.style.display = (s.style.display==='block')?'none':'block'; }
function updateS() { let db = getDB(); db[currentUser].score = score; saveDB(db); document.getElementById("gameScore").textContent = score; }

function setMood(m, el) { 
    selectedMood = m; 
    document.querySelectorAll(".mood-opt").forEach(o => {
        o.classList.remove('selected');
    });
    el.classList.add('selected');
}

function saveProfile() { let db = getDB(); db[currentUser].profile = { name: document.getElementById("pName").value, pronouns: document.getElementById("pPronouns").value, bio: document.getElementById("pBio").value, song: document.getElementById("pFavSong").value, artist: document.getElementById("pFavArtist").value, lyric: document.getElementById("pFavLyric").value }; saveDB(db); alert("updated!"); }
function loadTimeline(f = "") {
    const list = document.getElementById("timelineList"); list.innerHTML = ""; const entries = getDB()[currentUser].entries;
    document.getElementById("entryCounter").innerText = `${entries.length} memories`;
    entries.filter(e => e.song.toLowerCase().includes(f.toLowerCase())).forEach(e => {
        list.innerHTML += `<div class="card" style="background:white"><span style="position:absolute; top:15px; right:15px; cursor:pointer; opacity:0.3;" onclick="deleteEntry(${e.id})">‚úï</span><b>${e.mood} ${e.song}</b><br><small>${e.date}</small><p>${e.notes}</p></div>`;
    });
}
function updateStreak() {
    const entries = getDB()[currentUser].entries; const dates = [...new Set(entries.map(e => e.date))];
    document.getElementById("dispStreak").innerText = `üî• ${dates.length} days`;
    const cal = document.getElementById("calGrid"); cal.innerHTML = "";
    for(let i=0; i<35; i++) cal.innerHTML += `<div class="cal-day ${i < dates.length ? 'active' : ''}"></div>`;
    document.getElementById("entryCounter").innerText = `${entries.length} memories`;
}
function confirmAction(t) { if(confirm("sure?")) { if(t==='delete') { let db = getDB(); delete db[currentUser]; saveDB(db); } location.reload(); } }
function openModal(title, text) { document.getElementById("modalOverlay").style.display = "flex"; document.getElementById("modalTitle").innerText = title; document.getElementById("modalText").innerText = text; }
function closeModal() { document.getElementById("modalOverlay").style.display = "none"; }
function nextQuestion() { document.getElementById("questionPrompt").textContent = "what song matches your energy right now?"; }
</script>
</body>
</html>
